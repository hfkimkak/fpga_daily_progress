# SPI Communication Protocol

## Project Overview
This project implements a complete Serial Peripheral Interface (SPI) communication system in VHDL. The design includes an SPI Master controller, an SPI Slave device, an EEPROM memory emulator using SPI, and a demonstration system showcasing their interaction.

## Repository Organization
* `src/` - Directory containing all VHDL source and testbench files
  * `spi_master.vhd` - SPI Master controller
  * `spi_slave.vhd` - SPI Slave interface for testing
  * `spi_eeprom.vhd` - SPI EEPROM memory emulator
  * `spi_eeprom_demo.vhd` - Top-level demonstration design
  * `spi_eeprom_demo_tb.vhd` - Testbench for the demonstration

## SPI Protocol Description
Serial Peripheral Interface (SPI) is a synchronous serial communication protocol used for short-distance communication, primarily in embedded systems. It operates in a full-duplex mode where a master device exchanges data with one or more slave devices.

### Key Features of SPI
* **Full-duplex communication** - Data can be transmitted and received simultaneously
* **Master-slave architecture** - One master controls multiple slaves
* **Four-wire interface**:
  * SCLK (Serial Clock) - Clock signal generated by the master
  * MOSI (Master Out Slave In) - Data from master to slave
  * MISO (Master In Slave Out) - Data from slave to master
  * CS/SS (Chip Select/Slave Select) - Selects the slave device (active low)
* **Flexible configuration** - Clock polarity (CPOL) and phase (CPHA) can be configured

### SPI Mode Configuration
SPI has four modes (0-3) defined by clock polarity (CPOL) and clock phase (CPHA):

| Mode | CPOL | CPHA | Clock Idle | Data Sampling   |
|------|------|------|------------|-----------------|
| 0    | 0    | 0    | Low        | Rising Edge     |
| 1    | 0    | 1    | Low        | Falling Edge    |
| 2    | 1    | 0    | High       | Falling Edge    |
| 3    | 1    | 1    | High       | Rising Edge     |

## Module Descriptions

### SPI Master (`spi_master.vhd`)
The SPI Master controller initiates and controls all SPI transactions. It generates the clock signal and manages data transfer with slave devices.

**Features:**
* Configurable clock frequency via generics
* Adjustable data width
* Selectable clock polarity (CPOL) and phase (CPHA)
* Support for MSB-first or LSB-first transmission
* Simple interface with start signal and busy indicator
* Full-duplex operation with simultaneous data transmission and reception

### SPI Slave (`spi_slave.vhd`)
The SPI Slave module provides a flexible SPI slave interface for testing and integration with the master.

**Features:**
* Configurable data width
* Selectable clock polarity and phase settings
* Support for MSB-first or LSB-first data order
* Transaction detection and completion signaling
* Full-duplex operation matching the master configuration

### SPI EEPROM (`spi_eeprom.vhd`)
This module emulates a standard SPI EEPROM memory device, providing a practical application example for the SPI interface.

**Features:**
* Supports standard EEPROM commands (READ, WRITE, WREN, WRDI, RDSR, WRSR)
* Implements a 128-byte memory array (configurable size)
* Includes status register with write protection features
* Models typical EEPROM timing requirements

### SPI EEPROM Demo (`spi_eeprom_demo.vhd`)
This is a top-level demonstration module showcasing SPI communication with an EEPROM device.

**Features:**
* Button-controlled interface for initiating read and write operations
* LED status indicators for operation progress and results
* Test pattern generation and verification
* Complete system integration with both master and slave components

## Implementation Details

### Configurable Parameters
Most modules include generics for flexible configuration:
* `CLK_FREQ_HZ_g` - System clock frequency
* `SPI_CLK_FREQ_HZ_g` - SPI clock frequency
* `DATA_WIDTH_g` - Data width for transactions (typically 8 bits)
* `CPOL_g` and `CPHA_g` - Clock polarity and phase settings
* `MSB_FIRST_g` - Data bit order selection

### State Machine Design
The modules use finite state machines (FSMs) to control the SPI protocol sequence:
* **SPI Master FSM**: Manages the setup, transfer, and completion of SPI transactions
* **SPI Slave FSM**: Responds to master clock and chip select signals
* **EEPROM FSM**: Implements the EEPROM command protocol and internal operations

### SPI Timing Considerations
The implementation properly handles:
* Clock edge synchronization based on CPOL and CPHA settings
* Setup and hold times for reliable data transfer
* Chip select timing for transaction framing
* Multi-byte transfers for command sequences

## Usage Instructions

### Instantiating the SPI Master
```vhdl
spi_master_inst : entity work.spi_master
    generic map (
        CLK_FREQ_HZ_g     => 100000000,     -- 100 MHz system clock
        SPI_CLK_FREQ_HZ_g => 1000000,       -- 1 MHz SPI clock
        DATA_WIDTH_g      => 8,             -- 8-bit data width
        CPOL_g            => '0',           -- Clock polarity
        CPHA_g            => '0',           -- Clock phase
        MSB_FIRST_g       => true           -- MSB first transmission
    )
    port map (
        clk_i         => system_clk,
        reset_n_i     => reset_n,
        start_i       => tx_start,
        busy_o        => spi_busy,
        tx_data_i     => tx_data,
        rx_data_o     => rx_data,
        rx_valid_o    => rx_valid,
        spi_sclk_o    => spi_clk,
        spi_mosi_o    => spi_mosi,
        spi_miso_i    => spi_miso,
        spi_cs_n_o    => spi_cs_n
    );
```

### Sending Data with the SPI Master
```vhdl
-- Example process for sending data
process(clk_i, reset_n_i)
begin
    if reset_n_i = '0' then
        tx_start <= '0';
        tx_data <= (others => '0');
        state <= IDLE;
    elsif rising_edge(clk_i) then
        tx_start <= '0'; -- Default value
        
        case state is
            when IDLE =>
                if send_data = '1' then
                    tx_data <= data_to_send;
                    tx_start <= '1';
                    state <= WAIT_COMPLETE;
                end if;
                
            when WAIT_COMPLETE =>
                if spi_busy = '0' then
                    state <= IDLE;
                end if;
        end case;
    end if;
end process;
```

### Using the EEPROM Emulator
The EEPROM emulator supports standard SPI EEPROM commands:
* `0x03` (READ) - Read data from memory
* `0x02` (WRITE) - Write data to memory
* `0x06` (WREN) - Write enable
* `0x04` (WRDI) - Write disable
* `0x05` (RDSR) - Read status register
* `0x01` (WRSR) - Write status register

Example sequence for writing to EEPROM:
1. Send WREN command
2. Send WRITE command followed by address and data
3. (Optional) Send RDSR command to check write completion

## Testing

The included testbench (`spi_eeprom_demo_tb.vhd`) verifies the functionality of the entire SPI system by:
1. Simulating button presses to initiate read and write operations
2. Monitoring SPI signal integrity and timing
3. Verifying data integrity through pattern matching
4. Checking operation status through LED indicators
5. Providing detailed transaction monitoring and statistics

To run the simulation:
```
# ModelSim/QuestaSim
vsim -t ns work.spi_eeprom_demo_tb
run -all

# GHDL
ghdl -a --std=08 *.vhd
ghdl -e --std=08 spi_eeprom_demo_tb
ghdl -r --std=08 spi_eeprom_demo_tb --wave=spi_test.ghw
```

## Applications

This SPI implementation can be used for:
* Communication with external memory devices (EEPROM, Flash)
* Interfacing with sensors (temperature, pressure, IMUs)
* Controlling peripheral devices (DACs, ADCs, display drivers)
* Data acquisition systems
* Configuration interfaces for FPGAs

## Future Enhancements

Potential improvements to the current implementation:
* Multi-slave support with individual chip select lines
* DMA integration for more efficient data transfers
* Enhanced error detection and recovery mechanisms
* Support for dual and quad SPI modes
* Integration with AXI or Avalon bus interfaces
* Higher-level protocol layers on top of SPI

## References

* [SPI Protocol Specification](https://www.nxp.com/docs/en/application-note/AN3020.pdf)
* [EEPROM Datasheets (Example: 25LC640)](https://ww1.microchip.com/downloads/en/DeviceDoc/22064F.pdf)
* [Interfacing SPI EEPROMs with FPGAs](https://www.xilinx.com/support/documentation/application_notes/xapp213.pdf) 